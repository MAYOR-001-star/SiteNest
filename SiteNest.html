<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <title>SiteNest | welcome page</title>
  <link rel="icon" href="./Site Nest.svg" type="image/x-icon">
  <link rel="stylesheet" href="./SiteNest.css">
</head>
<body>
  <div class="loader">
    <div class="box">
      <div class="logo">
        <svg width="106" height="101" viewBox="0 0 106 101" fill="none" xmlns="http://www.w3.org/2000/svg" class="svg">
          <mask id="mask0_3_32" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="106" height="39">
          <rect width="106" height="39" fill="black"/>
          </mask>
          <g mask="url(#mask0_3_32)">
          <path d="M10.336 0.399994H41.056V15.76H16.48L16.096 16.528L36.576 53.904C40.7573 61.4133 42.848 67.1307 42.848 71.056C42.848 79.6747 39.9893 85.9893 34.272 90H0.352V75.152H26.848L27.232 74.384L4.192 33.04C0.864 27.0667 -0.8 22.2027 -0.8 18.448C-0.8 9.57333 2.912 3.55733 10.336 0.399994ZM91.705 90L67.769 40.464L67.129 40.72L67.897 55.824V90H51.769V0.399994H64.697L88.249 51.856L88.889 51.6L87.481 35.856V0.399994H103.609V90H91.705Z" fill="#FAF3E0"/>
          </g>
          <mask id="mask1_3_32" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="62" width="106" height="39">
          <rect y="62" width="106" height="39" fill="#D9D9D9"/>
          </mask>
          <g mask="url(#mask1_3_32)">
          <path d="M10.336 10.4H41.056V25.76H16.48L16.096 26.528L36.576 63.904C40.7573 71.4133 42.848 77.1307 42.848 81.056C42.848 89.6747 39.9893 95.9893 34.272 100H0.352V85.152H26.848L27.232 84.384L4.192 43.04C0.864 37.0667 -0.8 32.2027 -0.8 28.448C-0.8 19.5733 2.912 13.5573 10.336 10.4ZM91.705 100L67.769 50.464L67.129 50.72L67.897 65.824V100H51.769V10.4H64.697L88.249 61.856L88.889 61.6L87.481 45.856V10.4H103.609V100H91.705Z" fill="#2D6A4F"/>
          </g>
          <path d="M12.456 49.9H15.576V51.46H13.08L13.041 51.538L15.121 55.334C15.5457 56.0967 15.758 56.6773 15.758 57.076C15.758 57.9513 15.4677 58.5927 14.887 59H11.442V57.492H14.133L14.172 57.414L11.832 53.215C11.494 52.6083 11.325 52.1143 11.325 51.733C11.325 50.8317 11.702 50.2207 12.456 49.9ZM16.664 59V49.9H18.445V59H16.664ZM21.1672 51.46H19.2042V49.9H24.8982V51.46H22.9352V59H21.1672V51.46ZM25.6523 59V49.9H30.3193V51.46H27.4333V53.631H30.0073V55.139H27.4333V57.492H30.3713V59H25.6523Z" fill="#2D6A47"/>
          <path d="M68.5423 59L64.0543 49.712L63.9343 49.76L64.0783 52.592V59H61.0543V42.2H63.4783L67.8943 51.848L68.0143 51.8L67.7503 48.848V42.2H70.7743V59H68.5423ZM73.0778 59V42.2H81.6938V45.08H76.3658V49.088H81.1178V51.872H76.3658V56.216H81.7898V59H73.0778ZM84.9497 42.2H90.7097V45.08H86.1017L86.0297 45.224L89.8697 52.232C90.6537 53.64 91.0457 54.712 91.0457 55.448C91.0457 57.064 90.5097 58.248 89.4377 59H83.0777V56.216H88.0457L88.1177 56.072L83.7977 48.32C83.1737 47.2 82.8617 46.288 82.8617 45.584C82.8617 43.92 83.5577 42.792 84.9497 42.2ZM95.4304 45.08H91.8064V42.2H102.318V45.08H98.6944V59H95.4304V45.08Z" fill="#FAF3E0"/>
          </svg>
      </div>
    </div>
    <div class="box"></div>
    <div class="box"></div>
  </div>

  <div class="container">
    <div class="header">
      <div style="display: flex; justify-content: center; align-items: center; gap: 5px;">
        <img src="./Site Nest.svg" alt="logo"/>
        <a href="/" style="font-size: 1.5rem;">SiteNest</a>
      </div>
      <div class="btns">
        <img src="./bars.svg" alt="open-btn" id="open-btn"/>
        <img src="./close.svg" alt="close-btn" id="close-btn"/>
      </div>
    </div>
    <div class="greetings-container">
      <p id="userlink"></p>
      <button id="sign_out" type="button">Logout</button><br>
    </div>
    <div class="content">
      
      

      <form id="blog-form">
        <input type="text" id="blog-title" placeholder="Title" required />
        <textarea id="blog-content" rows="10" cols="40" maxlength="500" placeholder="Enter your text here..." required></textarea>
        <p class="text-checker">
          <span class="total-character-left">900</span> characters left
        </p>
        <button id="blog-btn" type="submit">Add Blog</button>
      </form>

      <div id="bloggg">
        <h2>Your Blogs</h2>
        <ul id="blog-list"></ul>
      </div>
      

      <p>
        Don't have an account? <span><a href="./Create_Account.html">create account</a></span>
      </p>
      <p>
        Already have an account? <span><a href="./Login.html">login</a></span>
      </p>
    </div>
  </div>
  

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpbbUqwhYv9b4IWlE-D60hzwGCsa16nXA",
      authDomain: "sitenest-318b4.firebaseapp.com",
      projectId: "sitenest-318b4",
      storageBucket: "sitenest-318b4.appspot.com",
      messagingSenderId: "464415746140",
      appId: "1:464415746140:web:00391c12212d034e56de99"
    };

    // Initialize Firebase and Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore();

    // Select elements
    const sign_outBtn = document.querySelector("#sign_out");
    const userlink = document.querySelector("#userlink");
    const blogForm = document.querySelector("#blog-form");
    const blogTitle = document.querySelector("#blog-title");
    const blogContent = document.querySelector("#blog-content");
    const blogList = document.querySelector("#blog-list");
    const loader = document.querySelector(".loader");
    const container = document.querySelector(".container");
    const totalCharacter = document.querySelector(".total-character-left")

    
    window.addEventListener("load", ()=>{
      loader.classList.add("fadeOut")
      container.classList.add("fadeIn")
    })



    let currentUser = null;

    // Login function to determine if user is logged in
    function login() {
      if (localStorage.getItem("keepLoggedIn") === "yes") {
        currentUser = JSON.parse(localStorage.getItem("user"));
      } else {
        currentUser = JSON.parse(sessionStorage.getItem("user"));
      }
    }

    // Sign-out function
    function signOut() {
      localStorage.removeItem("user");
      localStorage.removeItem("keepLoggedIn");
      sessionStorage.removeItem("user");
      window.location.href = "./Login.html";
    }

    // Fetch and display blogs
    async function fetchAndDisplayBlogs() {
      if (!currentUser || !currentUser.email) return;

      blogList.innerHTML = ""; // Clear the list

      const blogsCollectionRef = collection(db, "users", currentUser.email, "blogs");
      const querySnapshot = await getDocs(blogsCollectionRef);

      querySnapshot.forEach((doc) => {
        const blog = doc.data();
        const li = document.createElement("li");
        li.textContent = `${blog.title}: ${blog.content}`;
        blogList.appendChild(li);
      });
    }

    // Add blog with duplicate title check
    blogForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      try {
        const email = currentUser.email;
        const title = blogTitle.value.trim();
        const content = blogContent.value.trim();

        if (!title || !content) {
          alert("All fields must be filled!");
          return;
        }

        const blogsCollectionRef = collection(db, "users", email, "blogs");
        const querySnapshot = await getDocs(blogsCollectionRef);

        const duplicate = querySnapshot.docs.find(
          (doc) => doc.data().title.toLowerCase() === title.toLowerCase()
        );

        if (duplicate) {
          alert("A blog with the same title already exists! Please use a different title.");
          return;
        }

        await addDoc(blogsCollectionRef, {
          title,
          content,
          createdAt: new Date(),
        });

        alert("Blog added successfully!");
        blogForm.reset(); // Clear form
        await fetchAndDisplayBlogs(); // Refresh blogs
      } catch (error) {
        console.error("Error adding blog:", error);
        alert(`Error: ${error.message}`);
      }
    });

    // Ensure DOM is fully loaded before running the script
    document.addEventListener("DOMContentLoaded", async () => {
      login();
      if (currentUser === null) {
        userlink.textContent = "Please login";
        blogForm.style.display = "none";
        document.querySelector("#bloggg").style.display = "none"
        sign_outBtn.style.display = "none"
      } else {
        userlink.textContent = `Welcome, ${currentUser.displayName || currentUser.username}`;
        blogForm.style.display = "block";
        document.querySelector("#bloggg").style.display = "block"
        sign_outBtn.style.display = "block"
        await fetchAndDisplayBlogs();
      }
    });

    sign_outBtn.addEventListener("click", signOut);


    function blogCharacter(){
      totalCharacter.innerHTML = blogContent.maxLength - blogContent.value.length
      if(totalCharacter.textContent <= 10){
        document.querySelector(".text-checker").style.color = "red"
      }
    }
    
    blogCharacter()

    blogContent.addEventListener("keyup", ()=>{
      if(blogContent && totalCharacter) {
        blogCharacter()
        document.querySelector("#blog-btn").disabled = false; 
      }else{
        document.querySelector("#blog-btn").disabled = true;  
      }
    })

    

  </script>
</body>
</html>

